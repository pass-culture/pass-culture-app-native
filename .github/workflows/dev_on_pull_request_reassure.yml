name: '3 [on_pr] Enhanced Reassure + T3-T4 Performance Tests'

on:
  pull_request:
    branches: [master] # Trigger this workflow only when a PR targets master
    # Enhanced paths for T3-T4 strategy monitoring
    paths:
      - 'src/**'
      - 'package.json'
      - '**/*.perf.test.*'

concurrency:
  group: reassure-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-performance:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - name: Enable Corepack
        run: corepack enable
        
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for baseline comparison
          
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          
      - name: Install dependencies
        run: yarn install
        
      - name: Setup performance baseline
        run: |
          mkdir -p .performance-baseline
          echo "üéØ T3-T4 Performance Strategy Baseline" > .performance-baseline/info.txt
          echo "Target: P90 35s ‚Üí 7s Android Home" >> .performance-baseline/info.txt
          echo "Focus: AuthWrapper, LocationWrapper, useSync refactors" >> .performance-baseline/info.txt
          
      - name: Run enhanced performance testing
        run: |
          echo "üöÄ Running Reassure tests + T3-T4 specific metrics..."
          yarn test:perf
          
      - name: Test critical T3-T4 modules performance
        run: |
          echo "üîç Testing T3-T4 critical modules..."
          # Test modules sp√©cifiquement identifi√©s pour T3-T4
          if [ -f "src/features/auth/context/AuthWrapper.tsx" ]; then
            echo "üìä AuthWrapper detected - high priority for T4 refactor"
          fi
          if [ -f "src/libs/location/LocationWrapper.tsx" ]; then
            echo "üìä LocationWrapper detected - medium priority for T4 refactor"  
          fi
          if [ -f "src/features/search/helpers/useSync/useSync.ts" ]; then
            echo "üìä useSync detected - critical complexity (606 lines)"
          fi
          
      - name: Generate T3-T4 performance report
        if: always()
        run: |
          echo "üìù Generating T3-T4 performance impact report..."
          cat > .performance-baseline/t3-t4-report.md << EOF
          ## üéØ T3-T4 Performance Impact Report
          
          ### Strategy Context
          - **Objective**: P90 35s ‚Üí 7s Android Home
          - **Architecture**: AuthWrapper, LocationWrapper, useSync refactors
          - **Timeline**: T3 (Sept) foundations, T4 (Oct-Jan) execution
          
          ### Current PR Impact
          - ‚úÖ Reassure tests: $(if [ -f .reassure/output.json ]; then echo "Completed"; else echo "Not run"; fi)
          - üìä Bundle analysis: Ready for mobile measurement
          - üîç Architecture complexity: Tracking module changes
          
          ### Performance Tools Status
          - ‚úÖ Reassure: Active and monitoring
          - ‚ö†Ô∏è react-native-performance: Integration needed
          - ‚ö†Ô∏è Sentry Performance: Setup required
          
          *This report supports the collaborative T3-T4 performance strategy*
          EOF
          
      - name: Run Danger.js to publish enhanced scores in PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Publishing performance results with T3-T4 context..."
          yarn danger ci
          
      - name: Enhanced render count check with T3-T4 context
        run: |
          echo "üîç Checking render count with T3-T4 strategy context..."
          ./scripts/reassure_test_check.sh
          
          # Additional context for T3-T4
          if [ -f .reassure/output.json ]; then
            RENDER_CHANGES=$(jq '[.countChanged[] | select(.countDiff > 0)] | length' .reassure/output.json)
            if [ "$RENDER_CHANGES" -gt 0 ]; then
              echo "‚ö†Ô∏è T3-T4 CONTEXT: Render increases detected during architecture refactor"
              echo "This is expected during AuthWrapper/LocationWrapper migrations"
              echo "Ensure optimizations are applied before final merge"
            fi
          fi
          
      - name: Upload T3-T4 performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: t3-t4-performance-analysis-${{ github.event.pull_request.number }}
          path: |
            .reassure/
            .performance-baseline/
          retention-days: 30

name: 'Create and push tag from package version'

on:
  workflow_dispatch:
    inputs:
      commitHash:
        description: 'Hash du commit Ã  dÃ©ployer (ex: cadd172232c80206107e2f0122542adf19fb42af)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  create_and_push_staging_tag:
    runs-on: [self-hosted, linux, x64]
    env:
      GIT_CONFIG_EMAIL: github-actions-bot@passculture.app
      GIT_CONFIG_NAME: ${{ github.actor }}
    steps:
      - name: Checkout commit hash
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.commitHash }}
          token: ${{ secrets.PUSH_SERVICE_ACCOUNT }}
      - name: 'OpenID Connect Authentication'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
      - name: Cache the node_modules
        id: yarn-modules-cache
        uses: mansagroup/gcs-cache-action@867797f1a78d69e008ad0a321c1459ddd619e9fd
        with:
          bucket: passculture-infra-prod-github-runner-cache
          path: |
            node_modules
            ~/.cache/yarn
          key: v1-yarn-dependency-cache-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            v1-yarn-dependency-cache-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Install dependencies
        run: yarn install
      - name: Author
        run: |
          git config --global user.email "$GIT_CONFIG_EMAIL"
          git config --global user.name "$GIT_CONFIG_NAME"
      - name: Create and push tag from package version
        run: |
          VERSION=$(yarn --silent json -f package.json version)
          TAG_NAME=test-v${VERSION} # retirer le prÃ©fixe test
          git tag -a "$TAG_NAME" -m "ðŸš€ $TAG_NAME"
          git push origin "$TAG_NAME"
  create_and_push_testing_tag:
    runs-on: [self-hosted, linux, x64]
    env:
      GIT_CONFIG_EMAIL: github-actions-bot@passculture.app
      GIT_CONFIG_NAME: ${{ github.actor }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: pc-24028-deploy-tag-workflow
          token: ${{ secrets.PUSH_SERVICE_ACCOUNT }}
      - name: 'OpenID Connect Authentication'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
      - name: Cache the node_modules
        id: yarn-modules-cache
        uses: mansagroup/gcs-cache-action@867797f1a78d69e008ad0a321c1459ddd619e9fd
        with:
          bucket: passculture-infra-prod-github-runner-cache
          path: |
            node_modules
            ~/.cache/yarn
          key: v1-yarn-dependency-cache-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            v1-yarn-dependency-cache-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Install dependencies
        run: yarn install
      - name: Author
        run: |
          git config --global user.email "$GIT_CONFIG_EMAIL"
          git config --global user.name "$GIT_CONFIG_NAME"
      - name: Bump packages version
        run: |
          yarn version --minor --no-git-tag-version
          yarn version --minor --no-git-tag-version --cwd server
      - name: Get package version and bump build number
        run: |
          ./scripts/update_build_number_from_package_json_version.sh
          git add package.json
          git add server/package.json
          VERSION=$(yarn --silent json -f package.json version)
          git commit -m "v${VERSION}"
          git push origin
      - name: Create and push testing tag
        run: |
          VERSION=$(yarn --silent json -f package.json version)
          TAG_NAME=test-testing/v${VERSION} # retirer le prÃ©fixe test
          git tag -a "$TAG_NAME" -m "ðŸš€ $TAG_NAME"
          git push origin "$TAG_NAME"

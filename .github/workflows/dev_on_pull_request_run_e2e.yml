name: '[on_pr] Run E2E tests from given branch when labeled'

on:
  pull_request:
    types: [labeled]

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  notify_test_launch:
    if: |
      github.event.label.name == 'e2e iOS' ||
      github.event.label.name == 'e2e Android'
    runs-on: ubuntu-latest
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label.name;
            const platform = label.includes('iOS') ? 'iOS' : 'Android';
            const dashboardLink = platform === 'iOS' 
              ? 'https://app.maestro.dev/project/proj_01javz1ncreqb9dcshv3y4da44/maestro-tests/app/app_01jk8x3ck0e6dansmsrx4g1h6z'
              : 'https://app.maestro.dev/project/proj_01javz1ncreqb9dcshv3y4da44/maestro-tests/app/app_01jawmdb0kfyk9tpg40habrw36';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Les tests E2E ${platform} ont Ã©tÃ© lancÃ©s !

              Les rÃ©sultats seront disponibles :
              - Dans le canal Slack #equipe-e2e-jeunes
              - Sur le [dashboard Maestro Cloud](${dashboardLink})
              
              Bonne journÃ©e ! ðŸŒŸ`
            })

  e2e-tests-ios:
    if: github.event.label.name == 'e2e iOS'
    needs: notify_test_launch
    uses: ./.github/workflows/dev_on_workflow_call_e2e_ios.yml
    with:
      upload_name_prefix: '[e2e iOS]-[${{ github.head_ref }}]'
    secrets:
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}

  e2e-tests-android:
    if: github.event.label.name == 'e2e Android'
    needs: notify_test_launch
    uses: ./.github/workflows/dev_on_workflow_call_e2e_android.yml
    with:
      upload_name_prefix: '[e2e Android]-[${{ github.head_ref }}]'
    secrets:
      GCP_EHP_SERVICE_ACCOUNT: ${{ secrets.GCP_EHP_SERVICE_ACCOUNT }}
      GCP_EHP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_EHP_WORKLOAD_IDENTITY_PROVIDER }}

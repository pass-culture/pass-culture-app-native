<div align=center>
  <img src="https://storage.googleapis.com/passculture-metier-prod-production-assets-fine-grained/assets/passculture.gif" style="width: 360px">
  <br />
  <a href="https://apps.apple.com/fr/app/pass-culture/id1557887412">
    <img src="https://upload.wikimedia.org/wikipedia/commons/4/40/Download_on_the_App_Store_Badge_FRCA_RGB_blk.svg" style="height: 50px">
  </a>

  <a href="https://play.google.com/store/apps/details?id=app.passculture.webapp&hl=fr">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/8e/Google_Play_Store_badge_FR.svg" style="height: 50px; padding-left: 12px">
  </a>
</div>

---

[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=pass-culture_pass-culture-app-native&metric=alert_status)](https://sonarcloud.io/summary/overall?id=pass-culture_pass-culture-app-native) [![Coverage](https://sonarcloud.io/api/project_badges/measure?project=pass-culture_pass-culture-app-native&metric=coverage)](https://sonarcloud.io/summary/overall?id=pass-culture_pass-culture-app-native)

![Current tests](https://img.shields.io/github/checks-status/pass-culture/pass-culture-app-native/master?label=Master%20tests)
[![Testing Environement](https://img.shields.io/github/deployments/pass-culture/pass-culture-app-native/testing?label=Testing%20Environment)](https://github.com/pass-culture/pass-culture-app-native/deployments/activity_log?environment=testing)
[![Staging Environement](https://img.shields.io/github/deployments/pass-culture/pass-culture-app-native/staging?label=Staging%20Environment)](https://github.com/pass-culture/pass-culture-app-native/deployments/activity_log?environment=staging)

[![Tag](https://img.shields.io/github/v/tag/pass-culture/pass-culture-app-native)](https://github.com/pass-culture/pass-culture-app-native/tags)

This project has been generated by [react-native-make](https://github.com/bamlab/react-native-make).

## Getting Started

To be able to install and run the mobile apps (iOS and Android) and web app, you first need to :

- [Setup](./doc/installation/setup.md) your environment
- Configure Sentry through [this tutorial](https://github.com/pass-culture/pass-culture-app-native/blob/master/doc/installation/sentry.md#-configure-sentry-cli)

#### üì± Mobile

To run the mobile app on Android or iOS, you will need to follow the installation steps:

- Install the [Android app](./doc/installation/Android.md)
- Install the [iOS app](./doc/installation/iOS.md)

#### üíª Web

To run the web app on your browser, follow the steps [here](./doc/installation/web.md)

#### üíÑ Storybook

Access to the [storybook](https://master--61fd537ecf081f003a135235.chromatic.com/).

To run the storybook on your browser, follow the steps [here](./doc/development/tests/storybook.md)

#### üçã Allure report

Access to the [Allure report](https://special-goggles-reogzj6.pages.github.io/).

## Development

### Debugging

Starting in react-native 0.76, we use the [integrated dev tools](https://reactnative.dev/blog/2024/10/23/release-0.76-new-architecture#react-native-devtools)

### Standards

In the `doc/` folder you will find the `dev standards` the team members follow:

- [code structure](./doc/development/code-structure.md).
- [error and crash management](./doc/development/error-management.md).
- [variable naming](./doc/development/naming.md).
- [testing strategy](./doc/development/tests/unit-test/).
- [PR title format](./doc/pull-request.md).

<details>
  <summary>To add a dev standard</summary>
  
Standards can of course be improved and new ones can be added.

1.  Create a pull request with the standard modification/addition (use `TEMPLATE.md` for addition)
2.  Ask **all** team members to read your PR

> Why: so that the team is aligned on how to code, and the best way to do something is shared within all members

3.  Make sure you got the approval of every member of the team
4.  You can merge :)
</details>

### Testing

You can run the tests with `yarn test`. This command will:

- Run `eslint` on your project
- Check the typescript types
- Run the `jest` tests

You can run the jest tests in watch mode with:

```bash
yarn jest --watch
```

You can also get the coverage with:

```bash
yarn jest --coverage
```

### Local development

<details>
  <summary>üìù Update the API schema</summary>
If the backend changes the api schema, you will need to update it:

- pull the `swagger-codegen-cli-v3` image: `docker pull swaggerapi/swagger-codegen-cli-v3`
- run: `yarn generate:api:client`
- or run `yarn generate:api:client:silicon` on Apple Silicon chips

If the file `src/api/gen/.swagger-codegen/VERSION` changes, make sure you locally have the desired version of `swagger-codegen-cli`, otherwise run `docker pull swaggerapi/swagger-codegen-cli-v3:3.0.24`

</details>

<details>
  <summary>To develop with a local API</summary>
  
See [the docs](./doc/development/how-to/run-local-api.md) to learn how to develop with a local API "superficially".

The other option, more complex, is to create a specific scheme 'Development' with a `.env.development` file :
copy the `.env.testing` configuration and update the `API_BASE_URL` setting with you local server address.

Make sure you also overload the `BATCH_API_PUBLIC_KEY_ANDROID` and `BATCH_API_PUBLIC_KEY_IOS` variables with the _dev_ values of the _testing_ [batch project](https://dashboard.batch.com/).

Then copy `testing.keystore` into `development.keystore` and `testing.keystore.properties` into `development.keystore.properties`. Replace the `storeFile` value in `development.keystore.properties`.

</details>

<details>
  <summary>Test login credentials</summary>

See in [Keeper][1] for all testing accounts.

</details>

### ‚¨áÔ∏è Download

To download the **testing** app, visit Appcenter for [iOS][2] and [Android][3].
For the **staging** app, use these links for [iOS][4] and [Android][5].

‚ö†Ô∏è Make sure your device is registered in the [device list][6].

---

## Deployment

See doc about deployment process [here](./doc/ci-cd/deployment.md) for the mobile application.

[1]: https://keepersecurity.eu/vault/#
[2]: https://appcenter.ms/orgs/pass-Culture/apps/passculture-testing-ios
[3]: https://appcenter.ms/orgs/pass-Culture/apps/passculture-testing-android
[4]: https://appcenter.ms/orgs/pass-Culture/apps/passculture-staging-ios
[5]: https://appcenter.ms/orgs/pass-Culture/apps/passculture-staging-android
[6]: https://developer.apple.com/account/resources/devices/list

## Performances

You can find most of the code related to performance measurement in `src/performance`.

### Mobile performances

#### Local development

For local development, you can monitor the performances by pressing `d` in your metro console. The developer menu should popup on your emulator. Press the "performance monitor" button. You can track the JS thread, UI thread and RAM usage on features you are developing.

#### Deployed versions (Android only)

Thanks to maestro and flashlight, we are able to have a measure for each version of the app in the CI.

[Here are examples of runs](https://github.com/pass-culture/pass-culture-app-native/actions/workflows/dev_on_schedule_flashlight_android.yml).

Additionally, you can add a tag `e2e perfs` to your PR to get the flashlight performance score of your feature.

Here is an example of a flashlight performance report:

```
===== Aggregated Performance Summary =====
  - Overall Score            82.00 / 100
  - Successful Iterations    10 / 10

===== Averaged Metrics (across all successful runs) =====
  - Average FPS              39
  - Average RAM Usage        250 MB
  - Average Total CPU        51 %

===== Average CPU Usage Per Thread =====
  - UI Thread                4.45 %
  - mqt_js                   0.00 %
  - RenderThread             30.27 %
```

#### Production measurements

Starting in the version v344, to measure performances, we have decided to measure the time to interactive of the home (see [adr](./doc/decision-records/DR007%20-%20mesure-performances.md))

At the moment, it would seem that the measure is more reliable on iOS (between 10 and 20 seconds) than on Android (where we are getting ttis of more than 40 seconds). Because of the way we measure the tti (we trigger an event when the Home finishes loading) if any screen interposes itself between the start of the app and the Home, the time the user spends on that screen will be counted in the tti, thus producing erroneous measures. We are still investigating possible issues.

You can find this measure on firebase performance monitor for the different environments:

- [testing iOS](https://console.firebase.google.com/project/pc-native-testing/performance/app/ios:app.passculture.test/troubleshooting/trace/DURATION_TRACE/home_time_to_interactive_container/counter/home_time_to_interactive_in_ms?hl=fr)
- [testing Android](https://console.firebase.google.com/project/pc-native-testing/performance/app/android:app.passculture.testing/troubleshooting/trace/DURATION_TRACE/home_time_to_interactive_container/counter/home_time_to_interactive_in_ms?hl=fr)
- [staging iOS](https://console.firebase.google.com/project/pc-native-staging/performance/app/ios:app.passculture.staging/trends?hl=fr)
- [staging Android](https://console.firebase.google.com/project/pc-native-staging/performance/app/android:app.passculture.staging/trends?hl=fr)
- [production iOS](https://console.firebase.google.com/project/pc-native-production/performance/app/ios:app.passculture/troubleshooting/trace/DURATION_TRACE/home_time_to_interactive_container/counter/home_time_to_interactive_in_ms?hl=fr&time=24h)
- [production Android](https://console.firebase.google.com/project/pc-native-production/performance/app/android:app.passculture.webapp/troubleshooting/trace/DURATION_TRACE/home_time_to_interactive_container/counter/home_time_to_interactive_in_ms?hl=fr&time=24h)

### Web performances

We currently use lighthouse to measure performances on the web app. There is a job that runs lighthouse in the CI once a week, you can see the runs [here](https://github.com/pass-culture/pass-culture-app-native/actions/workflows/dev_on_schedule_lighthouse.yml).

By running the performance test once a week, we have a measure for each version of the app. Here is an example of a report:

```
--- Lighthouse Performance Summary ---
üü¢ Performance Score: 48 / 100
 FCP: 0.8 s
 LCP: 16.6 s
 TBT: 590 ms
 CLS: 0.108
------------------------------------

You can also run lighthouse locally from your browser's dev tools (make sure to run them in incognito mode to avoid extensions degrading performances).
```

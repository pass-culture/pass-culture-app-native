# PassCulture

This project and readme have been auto generated by [react-native-make](https://github.com/bamlab/react-native-make)

## Getting Started


### Workstation SetUp (for Android)

####Install NVM (optional):
You can follow this tutorial:
`https://www.liquidweb.com/kb/how-to-install-node-version-manager-on-ubuntu/`

####Install nodejs:
If you have already installed NVM, a .nvmrc file at project root allow you to directly setup the expected version like this:
`nvm use`

####Install React Native CLI:
`npm install -g react-native-cli`

####Intall Android Studio and Android SDK:
`https://developer.android.com/studio`

####Install KVM utility:
`sudo apt install qemu-kvm
sudo adduser <Replace with username> kvm
sudo chown <Replace with username> /dev/kvm`

####Configure Android PATH
Add ANDROID to your current PATH env var, by adding theses line in your .bashrc:
`export ANDROID_HOME=$HOME/tools/sdk
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/platform-tools`


### Run the app

####Android
In order to launch the app in your simulator, you need to go to Android Studio first.
Then open the Android Virtual Devices Manager and select (or create) a Virtual Device with the android version you want to run.
Once the emulator is up and running, go to your terminal in the project workspace and run the following command:
`yarn install
yarn launch`

####IOS
On iOS you can run the following command:
`react-native run-ios --scheme PassCulture-Staging`

## Features

When you generated the repository with [react-native-make](https://github.com/bamlab/react-native-make) the following feature must be present:

- A repository should have been created at https://github.com/bamlab/project-name
- An application have been created and deployed on appcenter
- You can deploy automatically with fastlane to appcenter
- You can deploy with codepush to staging too
- We installed the following libraries for you:
  - @react-native-community/async-storage
  - react-native-localize
  - lingui-js
  - typesafe-actions
  - jest
  - prettier
  - eslint

## Finding specific features location

To find where a feature is installed / used, run a search on the whole project using the tag

| Name             | Â Tag              |
| ---------------- | ----------------- |
| Translations     | @translations     |
| React Navigation | @react-navigation |
| CodePush         | @codepush         |

## Testing

You can run the tests with `yarn test`. This command will:

- Run `eslint` on your project
- Check the typescript types
- Run the `jest` tests

You can run the jest tests in watch mode with:

```bash
yarn jest --watch
```

You can also get the coverage with:

```bash
yarn jest --coverage
```

## Automatic generation

You can automatically generate files by running the following commands:

- `yarn plop atom` : generate an empty atom
- `yarn plop page` : generate an empty page

## Deploy

### Testing (manual deploy for the moment)

You can find the testing app at:

- https://appcenter.ms/orgs/pass-Culture/apps/passculture-testing-ios
- https://appcenter.ms/orgs/pass-Culture/apps/passculture-testing-android

Pre-requisites:

- get testing.keystore file, put it in `android/keystores` folder
- get the keystore password, put it in `android/keystores/testing.keystore.properties`
- get the Appcenter API token, you will be asked for it

To deploy in testing environment, just run

```
./scripts/deploy.sh -t hard -o android
```

> Only android working for the moment

> Default env is testing, no need to specify it in the command

### Staging (manual deploy for the moment)

You can find the testing app at:

- https://appcenter.ms/orgs/pass-Culture/apps/passculture-staging-ios
- https://appcenter.ms/orgs/pass-Culture/apps/passculture-staging-android

Pre-requisites:

- get testing.keystore file, put it in `android/keystores folder`
- get the keystore password, put it in `android/keystores/staging.keystore.properties`
- get the Appcenter API token, you will be asked for it

To deploy in testing environment, just run

```
./scripts/deploy.sh -t hard -e staging -o android
```

There is few options on the deploy command. Please run the following command to have all usages:

```
./scripts/deploy.sh -h
```

### CodePush

Most of the time, on staging, you didn't change anything in the native code. If you changed only javascript code, you can run:

```
./scripts/deploy.sh
```

Then the build should be faster as only the javascript code have been published.

To download updates from the application, just open it and click on the "check update" button.

## Troubleshooting

In case of trouble during your workstation setup, try following the extra steps in this documentation:
`https://androidwave.com/install-and-setup-react-native-on-ubuntu/`

If you don't know what's happening int your application, you can still access the log with ADB:
`adb logcat`

### React Native
If you encounter this error during `react-native start` command:
`Error: ENOSPC: System limit for number of file watchers reached`

You can run the following commande line:
`echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p`

### Android Emulator
In Android Studio, when you want to start a virtual device, you might encounter this error message:
`Could not start AVD`

This might be linked to some missing permission on `/dev/kvm`. Try changing the ownership with your current user like this :
`sudo chown <YourUsername> /dev/kvm`

### Android: No value has been specified for property 'manifestOutputDirectory'.
In Android Studio: File > Settings > Experimental > Gradle -> uncheck "Only sync the active variant" checkbox.

/**
 ⚠️ Design System — Protected file
 Do not edit this file without prior approval from the Design System team.
 */

import React, { FunctionComponent, ReactNode, SetStateAction } from 'react'
import styled from 'styled-components/native'

import { AccessibilityRole } from 'libs/accessibilityRole/accessibilityRole'
import { RadioButton } from 'ui/designSystem/RadioButton/RadioButton'
import { Variant } from 'ui/designSystem/RadioButton/types'
import { SelectableSizing } from 'ui/designSystem/types'
import { ErrorFilled } from 'ui/svg/icons/ErrorFilled'
import { Typo } from 'ui/theme'

import { LabelVariant, renderRadioGroupLabel } from './labelUtils'
import { RadioButtonGroupOption } from './types'

type RadioButtonGroupDisplay = 'horizontal' | 'vertical'

type Props = {
  label: ReactNode
  description?: string
  labelVariant?: LabelVariant
  options: Array<RadioButtonGroupOption>
  errorText: string
  error?: boolean
  variant?: Variant
  disabled?: boolean
  display?: RadioButtonGroupDisplay
  value: string
  onChange: (value: string) => void
}

export const RadioButtonGroup: FunctionComponent<Props> = ({
  label,
  description,
  options,
  errorText,
  error = false,
  variant = 'default',
  disabled = false,
  display = 'vertical',
  labelVariant = 'body',
  value,
  onChange,
}: Props) => {
  const handleSetValue = (next: SetStateAction<string>) => {
    const resolved = typeof next === 'function' ? next(value) : next
    if (disabled || resolved === value) return
    onChange(resolved)
  }

  return (
    <RadioButtonGroupContainer accessibilityRole={AccessibilityRole.GROUP}>
      <TitleContainer>
        {renderRadioGroupLabel(label, labelVariant)}
        {description ? (
          labelVariant === 'title2' || labelVariant === 'title3' ? (
            <DescriptionBody>{description}</DescriptionBody>
          ) : (
            <DescriptionBodyS>{description}</DescriptionBodyS>
          )
        ) : null}
        {error ? (
          <ErrorContainer>
            <ErrorIcon />
            <ErrorText>{errorText}</ErrorText>
          </ErrorContainer>
        ) : null}
      </TitleContainer>
      <RadioButtonListContainer variant={variant} display={display}>
        {options.map((option) => (
          <RadioButton
            key={`rb-${option.label}`}
            label={option.label}
            disabled={disabled}
            error={error}
            value={value}
            setValue={handleSetValue}
            variant={variant}
            description={option.description}
            collapsed={option.collapsed}
            asset={option.asset}
            sizing={computedRadioButtonSizing(option.sizing, display)}
          />
        ))}
      </RadioButtonListContainer>
    </RadioButtonGroupContainer>
  )
}

const computedRadioButtonSizing = (
  sizing: SelectableSizing | undefined,
  display: RadioButtonGroupDisplay
) => {
  if (sizing) return sizing
  return display === 'horizontal' ? 'hug' : 'fill'
}

const RadioButtonGroupContainer = styled.View(({ theme }) => ({
  gap: theme.designSystem.size.spacing.s,
}))

const RadioButtonListContainer = styled.View<{
  variant: Variant
  display: RadioButtonGroupDisplay
}>(({ theme, variant, display }) => ({
  flexWrap: display === 'horizontal' ? 'wrap' : 'nowrap',
  flexDirection: display === 'vertical' ? 'column' : 'row',
  gap:
    display === 'vertical'
      ? variant === 'default'
        ? theme.designSystem.size.spacing.xl
        : theme.designSystem.size.spacing.s
      : theme.designSystem.size.spacing.l,
}))

const ErrorContainer = styled.View(({ theme }) => ({
  display: 'flex',
  flexDirection: 'row',
  alignItems: 'center',
  gap: theme.designSystem.size.spacing.xs,
}))

const TitleContainer = styled.View(({ theme }) => ({
  gap: theme.designSystem.size.spacing.xs,
}))

const DescriptionBody = styled(Typo.Body)(({ theme }) => ({
  color: theme.designSystem.color.text.subtle,
}))

const DescriptionBodyS = styled(Typo.BodyS)(({ theme }) => ({
  color: theme.designSystem.color.text.subtle,
}))

const ErrorText = styled(Typo.BodyXs)(({ theme }) => ({
  color: theme.designSystem.color.text.error,
}))

const ErrorIcon = styled(ErrorFilled).attrs(({ theme }) => ({
  size: theme.icons.sizes.extraSmall,
  color: theme.designSystem.color.icon.error,
}))``
